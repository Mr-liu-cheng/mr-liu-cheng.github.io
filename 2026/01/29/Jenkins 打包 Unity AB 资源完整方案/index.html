<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Jenkins 打包 Unity AB 资源完整方案 | LiuCheng's Blog</title><meta name="author" content="LiuCheng"><meta name="copyright" content="LiuCheng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Jenkins 打包 Unity AB 资源完整方案一、Jenkins + Unity 自动化构建架构1. 核心架构图12345678910111213141516171819202122232425┌─────────────────────────────────────────────────────────────┐│                    Jenkins 主服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins 打包 Unity AB 资源完整方案">
<meta property="og:url" content="https://mr-liu-cheng.github.io/2026/01/29/Jenkins%20%E6%89%93%E5%8C%85%20Unity%20AB%20%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88/">
<meta property="og:site_name" content="LiuCheng&#39;s Blog">
<meta property="og:description" content="Jenkins 打包 Unity AB 资源完整方案一、Jenkins + Unity 自动化构建架构1. 核心架构图12345678910111213141516171819202122232425┌─────────────────────────────────────────────────────────────┐│                    Jenkins 主服务器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mr-liu-cheng.github.io/img/favicon.png">
<meta property="article:published_time" content="2026-01-29T12:06:02.000Z">
<meta property="article:modified_time" content="2026-01-29T12:06:02.000Z">
<meta property="article:author" content="LiuCheng">
<meta property="article:tag" content="Jenkins,自动化,打包">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mr-liu-cheng.github.io/img/favicon.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mr-liu-cheng.github.io/2026/01/29/Jenkins%20%E6%89%93%E5%8C%85%20Unity%20AB%20%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-1389699351715193',
  enable_page_level_ads: 'true'
});</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Jenkins 打包 Unity AB 资源完整方案',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (true) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa-solid fa-book"></i><span> Doc</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> Archives</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tag</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa-solid fa-folder-tree"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/game/"><i class="fa-fw fa-solid fa-gamepad"></i><span> Game</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/About/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa-regular fa-pen-to-square"></i><span> More</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/musicPage/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page child" href="/%E5%BD%B1%E8%A7%86%E5%88%86%E4%BA%AB/"><i class="fa-fw fa-solid fa-film"></i><span> Vidio Sharing</span></a></li><li><a class="site-page child" href="/%E7%BE%8E%E9%A3%9F/"><i class="fa-fw fa-solid fa-mug-hot"></i><span> Delicious</span></a></li><li><a class="site-page child" href="/%E6%B8%B8%E8%AE%B0/"><i class="fa-fw fa-solid fa-person-hiking"></i><span> Tourist</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Calendar/"><i class="fa-fw fa-regular fa-calendar-check"></i><span> Calendar</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/favicon.png" alt="Logo"><span class="site-name">LiuCheng's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Jenkins 打包 Unity AB 资源完整方案</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa-solid fa-book"></i><span> Doc</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> Archives</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tag</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa-solid fa-folder-tree"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/game/"><i class="fa-fw fa-solid fa-gamepad"></i><span> Game</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/About/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa-regular fa-pen-to-square"></i><span> More</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/musicPage/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page child" href="/%E5%BD%B1%E8%A7%86%E5%88%86%E4%BA%AB/"><i class="fa-fw fa-solid fa-film"></i><span> Vidio Sharing</span></a></li><li><a class="site-page child" href="/%E7%BE%8E%E9%A3%9F/"><i class="fa-fw fa-solid fa-mug-hot"></i><span> Delicious</span></a></li><li><a class="site-page child" href="/%E6%B8%B8%E8%AE%B0/"><i class="fa-fw fa-solid fa-person-hiking"></i><span> Tourist</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Calendar/"><i class="fa-fw fa-regular fa-calendar-check"></i><span> Calendar</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Jenkins 打包 Unity AB 资源完整方案</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-29T12:06:02.000Z" title="发表于 2026-01-29 12:06:02">2026-01-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-29T12:06:02.000Z" title="更新于 2026-01-29 12:06:02">2026-01-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Jenkins/">Jenkins</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><h1 id="Jenkins-打包-Unity-AB-资源完整方案"><a href="#Jenkins-打包-Unity-AB-资源完整方案" class="headerlink" title="Jenkins 打包 Unity AB 资源完整方案"></a>Jenkins 打包 Unity AB 资源完整方案</h1><h2 id="一、Jenkins-Unity-自动化构建架构"><a href="#一、Jenkins-Unity-自动化构建架构" class="headerlink" title="一、Jenkins + Unity 自动化构建架构"></a>一、Jenkins + Unity 自动化构建架构</h2><h3 id="1-核心架构图"><a href="#1-核心架构图" class="headerlink" title="1. 核心架构图"></a>1. 核心架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Jenkins 主服务器                           │</span><br><span class="line">│                                                             │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                   Jenkins Pipeline                    │   │</span><br><span class="line">│  │  ┌─────────────┬─────────────┬──────────────┐      │   │</span><br><span class="line">│  │  │  拉取代码    │  构建AB包    │  部署分发     │      │   │</span><br><span class="line">│  │  │  Git Clone │ Unity Build │ Distribution │      │   │</span><br><span class="line">│  │  └─────────────┴─────────────┴──────────────┘      │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                             │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                    Jenkins Agent                     │   │</span><br><span class="line">│  │  (Windows/Mac with Unity &amp; Unity Build Tools)       │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                             │</span><br><span class="line">└─────────────────────────────────────────┬───────────────────┘</span><br><span class="line">                                          │</span><br><span class="line">            ┌─────────────────────────────┼─────────────────────────────┐</span><br><span class="line">            │                             │                             │</span><br><span class="line">            ▼                             ▼                             ▼</span><br><span class="line">    ┌───────────────┐             ┌───────────────┐             ┌───────────────┐</span><br><span class="line">    │   Git仓库      │             │   Unity工程    │             │   AB包存储     │</span><br><span class="line">    │  (代码管理)    │             │  (资源+脚本)   │             │   (产出物)     │</span><br><span class="line">    └───────────────┘             └───────────────┘             └───────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-环境准备清单"><a href="#2-环境准备清单" class="headerlink" title="2. 环境准备清单"></a>2. 环境准备清单</h3><h4 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a><strong>硬件环境</strong></h4><ul>
<li>Jenkins 主服务器 (Linux&#x2F;Windows)</li>
<li>Unity 构建节点 (Windows&#x2F;macOS，安装 Unity)</li>
<li>存储服务器 (存放生成的 AB 包)</li>
</ul>
<h4 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a><strong>软件环境</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">必备软件栈：</span><br><span class="line">1. Jenkins + Pipeline 插件</span><br><span class="line">2. Git (源码管理)</span><br><span class="line">3. Unity (指定版本，如 2021.3.x)</span><br><span class="line">4. Unity Build Tools (命令行构建工具)</span><br><span class="line">5. 7-Zip/WinRAR (压缩工具)</span><br><span class="line">6. Python/Batch/Shell 脚本工具</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、Jenkins-Pipeline-配置方案"><a href="#二、Jenkins-Pipeline-配置方案" class="headerlink" title="二、Jenkins Pipeline 配置方案"></a>二、Jenkins Pipeline 配置方案</h2><h3 id="方案1：Jenkinsfile-Pipeline-推荐"><a href="#方案1：Jenkinsfile-Pipeline-推荐" class="headerlink" title="方案1：Jenkinsfile Pipeline (推荐)"></a>方案1：Jenkinsfile Pipeline (推荐)</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkinsfile - 放在 Unity 项目根目录</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            <span class="symbol">name:</span> <span class="string">&#x27;BUILD_PLATFORM&#x27;</span>,</span><br><span class="line">            <span class="symbol">choices:</span> [<span class="string">&#x27;StandaloneWindows64&#x27;</span>, <span class="string">&#x27;Android&#x27;</span>, <span class="string">&#x27;iOS&#x27;</span>, <span class="string">&#x27;WebGL&#x27;</span>],</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&#x27;选择构建平台&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        choice(</span><br><span class="line">            <span class="symbol">name:</span> <span class="string">&#x27;AB_BUILD_TYPE&#x27;</span>,</span><br><span class="line">            <span class="symbol">choices:</span> [<span class="string">&#x27;Full&#x27;</span>, <span class="string">&#x27;Incremental&#x27;</span>, <span class="string">&#x27;Clean&#x27;</span>],</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&#x27;AB包构建类型&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        string(</span><br><span class="line">            <span class="symbol">name:</span> <span class="string">&#x27;AB_VERSION&#x27;</span>,</span><br><span class="line">            <span class="symbol">defaultValue:</span> <span class="string">&#x27;1.0.$&#123;BUILD_NUMBER&#125;&#x27;</span>,</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&#x27;AB包版本号&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        booleanParam(</span><br><span class="line">            <span class="symbol">name:</span> <span class="string">&#x27;UPLOAD_TO_CDN&#x27;</span>,</span><br><span class="line">            <span class="symbol">defaultValue:</span> <span class="literal">true</span>,</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&#x27;是否上传到CDN&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    environment &#123;</span><br><span class="line">        <span class="comment">// Unity 安装路径 (Windows示例)</span></span><br><span class="line">        UNITY_PATH = <span class="string">&#x27;C:\\Program Files\\Unity\\Hub\\Editor\\2021.3.21f1\\Editor\\Unity.exe&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 项目路径</span></span><br><span class="line">        PROJECT_PATH = <span class="string">&#x27;D:\\Jenkins\\workspace\\$&#123;JOB_NAME&#125;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 输出路径</span></span><br><span class="line">        OUTPUT_PATH = <span class="string">&#x27;D:\\AB_Output\\$&#123;BUILD_NUMBER&#125;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Python 脚本路径</span></span><br><span class="line">        PYTHON_SCRIPT = <span class="string">&#x27;$&#123;WORKSPACE&#125;\\BuildScripts\\build_ab.py&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;清理工作空间&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                cleanWs()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;拉取代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;$&#123;GIT_BRANCH&#125;&#x27;</span>,</span><br><span class="line">                    <span class="symbol">url:</span> <span class="string">&#x27;git@github.com:your-company/unity-game.git&#x27;</span>,</span><br><span class="line">                    <span class="symbol">credentialsId:</span> <span class="string">&#x27;git-credentials&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;准备构建环境&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 创建输出目录</span></span><br><span class="line">                    bat <span class="string">&quot;mkdir $&#123;OUTPUT_PATH&#125;&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 备份上一版本的 AB 包 (用于增量构建)</span></span><br><span class="line">                    <span class="keyword">if</span> (params.AB_BUILD_TYPE == <span class="string">&#x27;Incremental&#x27;</span>) &#123;</span><br><span class="line">                        bat <span class="string">&quot;xcopy D:\\AB_Output\\latest\\*.* $&#123;OUTPUT_PATH&#125;\\previous\\ /E /Y&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;构建 AssetBundle&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 方法1: 使用 Unity 命令行构建</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        &quot;$&#123;UNITY_PATH&#125;&quot; \\</span></span><br><span class="line"><span class="string">                        -batchmode \\</span></span><br><span class="line"><span class="string">                        -nographics \\</span></span><br><span class="line"><span class="string">                        -silent-crashes \\</span></span><br><span class="line"><span class="string">                        -projectPath &quot;$&#123;PROJECT_PATH&#125;&quot; \\</span></span><br><span class="line"><span class="string">                        -executeMethod AssetBundleBuilder.BuildAll \\</span></span><br><span class="line"><span class="string">                        -buildTarget $&#123;params.BUILD_PLATFORM&#125; \\</span></span><br><span class="line"><span class="string">                        -buildType $&#123;params.AB_BUILD_TYPE&#125; \\</span></span><br><span class="line"><span class="string">                        -outputPath &quot;$&#123;OUTPUT_PATH&#125;&quot; \\</span></span><br><span class="line"><span class="string">                        -logFile &quot;$&#123;OUTPUT_PATH&#125;\\build.log&quot; \\</span></span><br><span class="line"><span class="string">                        -quit</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 方法2: 使用 Python 脚本构建 (更灵活)</span></span><br><span class="line">                    <span class="comment">// bat &quot;python $&#123;PYTHON_SCRIPT&#125; --platform $&#123;params.BUILD_PLATFORM&#125; --type $&#123;params.AB_BUILD_TYPE&#125;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;生成版本文件&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 生成 manifest 文件</span></span><br><span class="line">                    writeFile <span class="attr">file:</span> <span class="string">&quot;$&#123;OUTPUT_PATH&#125;/version.json&quot;</span>, <span class="attr">text:</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                        &quot;version&quot;: &quot;$&#123;params.AB_VERSION&#125;&quot;,</span></span><br><span class="line"><span class="string">                        &quot;build_number&quot;: &quot;$&#123;BUILD_NUMBER&#125;&quot;,</span></span><br><span class="line"><span class="string">                        &quot;platform&quot;: &quot;$&#123;params.BUILD_PLATFORM&#125;&quot;,</span></span><br><span class="line"><span class="string">                        &quot;build_time&quot;: &quot;$&#123;new Date().format(&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;,</span></span><br><span class="line"><span class="string">                        &quot;files&quot;: [</span></span><br><span class="line"><span class="string">                            &#123;</span></span><br><span class="line"><span class="string">                                &quot;name&quot;: &quot;manifest&quot;,</span></span><br><span class="line"><span class="string">                                &quot;md5&quot;: &quot;$&#123;md5(file: &#x27;$&#123;OUTPUT_PATH&#125;/manifest&#x27;)&#125;&quot;,</span></span><br><span class="line"><span class="string">                                &quot;size&quot;: &quot;$&#123;fileSize(&#x27;$&#123;OUTPUT_PATH&#125;/manifest&#x27;)&#125;&quot;</span></span><br><span class="line"><span class="string">                            &#125;</span></span><br><span class="line"><span class="string">                        ]</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 计算所有文件的 MD5</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        cd &quot;$&#123;OUTPUT_PATH&#125;&quot;</span></span><br><span class="line"><span class="string">                        dir /b /s *.* &gt; filelist.txt</span></span><br><span class="line"><span class="string">                        python $&#123;WORKSPACE&#125;/BuildScripts/calc_md5.py filelist.txt files_md5.json</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;压缩打包&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 使用 7-Zip 压缩</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        7z a -tzip &quot;$&#123;OUTPUT_PATH&#125;/ab_package_$&#123;BUILD_NUMBER&#125;.zip&quot; &quot;$&#123;OUTPUT_PATH&#125;\\*&quot; -x!*.log</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 记录压缩包信息</span></span><br><span class="line">                    archiveArtifacts <span class="attr">artifacts:</span> <span class="string">&quot;$&#123;OUTPUT_PATH&#125;/ab_package_$&#123;BUILD_NUMBER&#125;.zip&quot;</span>, <span class="attr">fingerprint:</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;上传到 CDN&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                expression &#123; params.UPLOAD_TO_CDN == <span class="literal">true</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 上传到阿里云 OSS</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        python $&#123;WORKSPACE&#125;/BuildScripts/upload_to_oss.py \\</span></span><br><span class="line"><span class="string">                        --file &quot;$&#123;OUTPUT_PATH&#125;/ab_package_$&#123;BUILD_NUMBER&#125;.zip&quot; \\</span></span><br><span class="line"><span class="string">                        --bucket game-ab-bucket \\</span></span><br><span class="line"><span class="string">                        --path &quot;v$&#123;params.AB_VERSION&#125;/&quot;</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 更新最新版本链接</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        echo &quot;https://cdn.yourgame.com/ab/v$&#123;params.AB_VERSION&#125;/&quot; &gt; $&#123;OUTPUT_PATH&#125;/cdn_url.txt</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;测试验证&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 1. 检查文件完整性</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        python $&#123;WORKSPACE&#125;/BuildScripts/check_ab_integrity.py \\</span></span><br><span class="line"><span class="string">                        --path &quot;$&#123;OUTPUT_PATH&#125;&quot; \\</span></span><br><span class="line"><span class="string">                        --platform $&#123;params.BUILD_PLATFORM&#125;</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 2. 生成测试报告</span></span><br><span class="line">                    junit <span class="string">&#x27;**/test-results/*.xml&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;通知与清理&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// 发送构建成功通知</span></span><br><span class="line">                    emailext (</span><br><span class="line">                        <span class="symbol">subject:</span> <span class="string">&quot;✅ Unity AB包构建成功 - #$&#123;BUILD_NUMBER&#125;&quot;</span>,</span><br><span class="line">                        <span class="symbol">body:</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        &lt;h2&gt;Unity AssetBundle 构建完成&lt;/h2&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;项目:&lt;/b&gt; $&#123;JOB_NAME&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;构建号:&lt;/b&gt; #$&#123;BUILD_NUMBER&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;平台:&lt;/b&gt; $&#123;params.BUILD_PLATFORM&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;版本:&lt;/b&gt; $&#123;params.AB_VERSION&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;构建时间:&lt;/b&gt; $&#123;new Date().format(&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;输出路径:&lt;/b&gt; $&#123;OUTPUT_PATH&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;b&gt;CDN地址:&lt;/b&gt; https://cdn.yourgame.com/ab/v$&#123;params.AB_VERSION&#125;/&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;&lt;a href=&quot;$&#123;BUILD_URL&#125;&quot;&gt;查看构建详情&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span>,</span><br><span class="line">                        <span class="symbol">to:</span> <span class="string">&#x27;dev-team@yourcompany.com&#x27;</span>,</span><br><span class="line">                        <span class="symbol">attachLog:</span> <span class="literal">true</span></span><br><span class="line">                    )</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 清理旧的构建 (保留最近10个)</span></span><br><span class="line">                    bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        forfiles /p &quot;D:\\AB_Output&quot; /d -10 /c &quot;cmd /c if @isdir==TRUE rmdir /s /q @path&quot;</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    post &#123;</span><br><span class="line">        always &#123;</span><br><span class="line">            <span class="comment">// 总是执行的清理操作</span></span><br><span class="line">            echo <span class="string">&#x27;构建流程结束&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        success &#123;</span><br><span class="line">            <span class="comment">// 构建成功时执行</span></span><br><span class="line">            echo <span class="string">&#x27;✅ AB包构建成功！&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            <span class="comment">// 构建失败时执行</span></span><br><span class="line">            echo <span class="string">&#x27;❌ AB包构建失败！&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送失败通知</span></span><br><span class="line">            emailext (</span><br><span class="line">                <span class="symbol">subject:</span> <span class="string">&quot;❌ Unity AB包构建失败 - #$&#123;BUILD_NUMBER&#125;&quot;</span>,</span><br><span class="line">                <span class="symbol">body:</span> <span class="string">&quot;构建失败，请查看日志: $&#123;BUILD_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="symbol">to:</span> <span class="string">&#x27;dev-team@yourcompany.com&#x27;</span>,</span><br><span class="line">                <span class="symbol">attachLog:</span> <span class="literal">true</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="方案2：Freestyle-Job-配置"><a href="#方案2：Freestyle-Job-配置" class="headerlink" title="方案2：Freestyle Job 配置"></a>方案2：Freestyle Job 配置</h3><p><strong>配置步骤：</strong></p>
<ol>
<li><strong>新建 Item</strong> → 选择 Freestyle project</li>
<li><strong>源码管理</strong> → Git → 填写仓库地址</li>
<li><strong>构建触发器</strong>：<ul>
<li>定时构建：<code>H 2 * * *</code> (每天凌晨2点)</li>
<li>Git Hook：GitLab&#x2F;GitHub webhook</li>
<li>手动构建</li>
</ul>
</li>
<li><strong>构建环境</strong>：<ul>
<li>Delete workspace before build starts</li>
<li>Provide Node &amp; npm bin&#x2F; folder to PATH</li>
</ul>
</li>
<li><strong>构建步骤</strong>：<ul>
<li>Execute Windows batch command</li>
<li>Execute Python script</li>
<li>Invoke Unity from command line</li>
</ul>
</li>
</ol>
<hr>
<h2 id="三、Unity-侧构建脚本"><a href="#三、Unity-侧构建脚本" class="headerlink" title="三、Unity 侧构建脚本"></a>三、Unity 侧构建脚本</h2><h3 id="1-Unity-C-构建脚本示例"><a href="#1-Unity-C-构建脚本示例" class="headerlink" title="1. Unity C# 构建脚本示例"></a>1. Unity C# 构建脚本示例</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assets/Editor/AssetBundleBuilder.cs</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetBundleBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Jenkins 调用的入口方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BuildAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从命令行参数获取配置</span></span><br><span class="line">        <span class="built_in">string</span> buildTargetStr = GetCommandLineArg(<span class="string">&quot;-buildTarget&quot;</span>);</span><br><span class="line">        <span class="built_in">string</span> buildType = GetCommandLineArg(<span class="string">&quot;-buildType&quot;</span>);</span><br><span class="line">        <span class="built_in">string</span> outputPath = GetCommandLineArg(<span class="string">&quot;-outputPath&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        BuildTarget buildTarget = ParseBuildTarget(buildTargetStr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置 AB 包输出目录</span></span><br><span class="line">        <span class="built_in">string</span> abOutputPath = Path.Combine(outputPath, buildTargetStr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清理旧的 Manifest</span></span><br><span class="line">        CleanOldManifests(abOutputPath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置 AB 包名称规则</span></span><br><span class="line">        SetAssetBundleNames();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构建 AB 包</span></span><br><span class="line">        BuildPipeline.BuildAssetBundles(</span><br><span class="line">            abOutputPath,</span><br><span class="line">            BuildAssetBundleOptions.ChunkBasedCompression | </span><br><span class="line">            BuildAssetBundleOptions.DeterministicAssetBundle,</span><br><span class="line">            buildTarget</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生成版本信息</span></span><br><span class="line">        GenerateVersionInfo(abOutputPath, buildTargetStr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 验证构建结果</span></span><br><span class="line">        ValidateBuildResult(abOutputPath);</span><br><span class="line">        </span><br><span class="line">        EditorApplication.Exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetAssetBundleNames</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 规则1: 按目录设置 AB 包名</span></span><br><span class="line">        SetBundleNameByDirectory(<span class="string">&quot;Assets/Resources/UI&quot;</span>, <span class="string">&quot;ui&quot;</span>);</span><br><span class="line">        SetBundleNameByDirectory(<span class="string">&quot;Assets/Resources/Characters&quot;</span>, <span class="string">&quot;characters&quot;</span>);</span><br><span class="line">        SetBundleNameByDirectory(<span class="string">&quot;Assets/Resources/Scenes&quot;</span>, <span class="string">&quot;scenes&quot;</span>);</span><br><span class="line">        SetBundleNameByDirectory(<span class="string">&quot;Assets/Resources/Sounds&quot;</span>, <span class="string">&quot;sounds&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 规则2: 按资源类型设置</span></span><br><span class="line">        SetBundleNameByExtension(<span class="string">&quot;Assets/Resources/Prefabs&quot;</span>, <span class="string">&quot;.prefab&quot;</span>, <span class="string">&quot;prefabs&quot;</span>);</span><br><span class="line">        SetBundleNameByExtension(<span class="string">&quot;Assets/Resources/Materials&quot;</span>, <span class="string">&quot;.mat&quot;</span>, <span class="string">&quot;materials&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 规则3: 大资源单独打包</span></span><br><span class="line">        SetSingleAssetBundle(<span class="string">&quot;Assets/Resources/BigTextures/bg_texture.png&quot;</span>, <span class="string">&quot;big_textures&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CleanOldManifests</span>(<span class="params"><span class="built_in">string</span> outputPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(outputPath))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span>[] files = Directory.GetFiles(outputPath, <span class="string">&quot;*.*&quot;</span>, SearchOption.AllDirectories);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> file <span class="keyword">in</span> files)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (file.EndsWith(<span class="string">&quot;.manifest&quot;</span>) || file.EndsWith(<span class="string">&quot;.meta&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    File.Delete(file);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateVersionInfo</span>(<span class="params"><span class="built_in">string</span> outputPath, <span class="built_in">string</span> platform</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 收集所有 AB 包信息</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, ABFileInfo&gt; fileInfos = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, ABFileInfo&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">string</span>[] abFiles = Directory.GetFiles(outputPath, <span class="string">&quot;*.ab&quot;</span>, SearchOption.AllDirectories);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> file <span class="keyword">in</span> abFiles)</span><br><span class="line">        &#123;</span><br><span class="line">            FileInfo fi = <span class="keyword">new</span> FileInfo(file);</span><br><span class="line">            <span class="built_in">string</span> relativePath = file.Replace(outputPath + <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="built_in">string</span> md5 = CalculateMD5(file);</span><br><span class="line">            </span><br><span class="line">            fileInfos[relativePath] = <span class="keyword">new</span> ABFileInfo</span><br><span class="line">            &#123;</span><br><span class="line">                name = Path.GetFileNameWithoutExtension(file),</span><br><span class="line">                size = fi.Length,</span><br><span class="line">                md5 = md5,</span><br><span class="line">                dependencies = GetDependencies(file)</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入 JSON 文件</span></span><br><span class="line">        <span class="built_in">string</span> json = JsonUtility.ToJson(<span class="keyword">new</span> ABManifest</span><br><span class="line">        &#123;</span><br><span class="line">            version = Application.version,</span><br><span class="line">            buildTime = System.DateTime.Now.ToString(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>),</span><br><span class="line">            platform = platform,</span><br><span class="line">            files = fileInfos</span><br><span class="line">        &#125;, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        File.WriteAllText(Path.Combine(outputPath, <span class="string">&quot;ab_manifest.json&quot;</span>), json);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span>[] <span class="title">GetDependencies</span>(<span class="params"><span class="built_in">string</span> abPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取 AB 包依赖关系</span></span><br><span class="line">        <span class="comment">// 实际实现需要读取 AssetBundleManifest</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">string</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Unity-命令行参数解析"><a href="#2-Unity-命令行参数解析" class="headerlink" title="2. Unity 命令行参数解析"></a>2. Unity 命令行参数解析</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 命令行参数解析工具</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CommandLineArgs</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; _args;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">CommandLineArgs</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _args = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="built_in">string</span>[] args = System.Environment.GetCommandLineArgs();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; args.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[i].StartsWith(<span class="string">&quot;-&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> key = args[i];</span><br><span class="line">                <span class="built_in">string</span> <span class="keyword">value</span> = (i + <span class="number">1</span> &lt; args.Length &amp;&amp; !args[i + <span class="number">1</span>].StartsWith(<span class="string">&quot;-&quot;</span>)) </span><br><span class="line">                    ? args[i + <span class="number">1</span>] </span><br><span class="line">                    : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                _args[key] = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetArg</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">string</span> defaultValue = <span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _args.ContainsKey(key) ? _args[key] : defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、辅助工具脚本"><a href="#四、辅助工具脚本" class="headerlink" title="四、辅助工具脚本"></a>四、辅助工具脚本</h2><h3 id="1-Python-构建控制脚本"><a href="#1-Python-构建控制脚本" class="headerlink" title="1. Python 构建控制脚本"></a>1. Python 构建控制脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BuildScripts/build_ab.py</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UnityABBuilder</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.unity_path = config.get(<span class="string">&#x27;unity_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.project_path = config.get(<span class="string">&#x27;project_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.output_path = config.get(<span class="string">&#x27;output_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行 Unity 构建&quot;&quot;&quot;</span></span><br><span class="line">        cmd = [</span><br><span class="line">            <span class="variable language_">self</span>.unity_path,</span><br><span class="line">            <span class="string">&#x27;-batchmode&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;-nographics&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;-silent-crashes&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;-projectPath&#x27;</span>, <span class="variable language_">self</span>.project_path,</span><br><span class="line">            <span class="string">&#x27;-executeMethod&#x27;</span>, <span class="string">&#x27;AssetBundleBuilder.BuildAll&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;-buildTarget&#x27;</span>, <span class="variable language_">self</span>.config[<span class="string">&#x27;platform&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;-buildType&#x27;</span>, <span class="variable language_">self</span>.config[<span class="string">&#x27;build_type&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;-outputPath&#x27;</span>, <span class="variable language_">self</span>.output_path,</span><br><span class="line">            <span class="string">&#x27;-logFile&#x27;</span>, os.path.join(<span class="variable language_">self</span>.output_path, <span class="string">&#x27;unity_build.log&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;-quit&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;执行命令: <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(cmd)&#125;</span>&quot;</span>)</span><br><span class="line">        result = subprocess.run(cmd, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> result.returncode != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f&quot;Unity 构建失败: <span class="subst">&#123;result.stderr&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_manifest</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成资源清单文件&quot;&quot;&quot;</span></span><br><span class="line">        manifest = &#123;</span><br><span class="line">            <span class="string">&quot;version&quot;</span>: <span class="variable language_">self</span>.config[<span class="string">&#x27;version&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;build_number&quot;</span>: <span class="variable language_">self</span>.config[<span class="string">&#x27;build_number&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;platform&quot;</span>: <span class="variable language_">self</span>.config[<span class="string">&#x27;platform&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;build_time&quot;</span>: datetime.now().isoformat(),</span><br><span class="line">            <span class="string">&quot;total_size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;files&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 遍历输出目录，收集文件信息</span></span><br><span class="line">        <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="variable language_">self</span>.output_path):</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">if</span> file.endswith(<span class="string">&#x27;.ab&#x27;</span>) <span class="keyword">or</span> file.endswith(<span class="string">&#x27;.json&#x27;</span>):</span><br><span class="line">                    file_path = os.path.join(root, file)</span><br><span class="line">                    relative_path = os.path.relpath(file_path, <span class="variable language_">self</span>.output_path)</span><br><span class="line">                    </span><br><span class="line">                    file_info = <span class="variable language_">self</span>.get_file_info(file_path, relative_path)</span><br><span class="line">                    manifest[<span class="string">&#x27;files&#x27;</span>].append(file_info)</span><br><span class="line">                    manifest[<span class="string">&#x27;total_size&#x27;</span>] += file_info[<span class="string">&#x27;size&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 写入 manifest 文件</span></span><br><span class="line">        manifest_path = os.path.join(<span class="variable language_">self</span>.output_path, <span class="string">&#x27;resource_manifest.json&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(manifest_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(manifest, f, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> manifest</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_file_info</span>(<span class="params">self, file_path, relative_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取文件详细信息&quot;&quot;&quot;</span></span><br><span class="line">        stat = os.stat(file_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: relative_path.replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>),</span><br><span class="line">            <span class="string">&quot;size&quot;</span>: stat.st_size,</span><br><span class="line">            <span class="string">&quot;md5&quot;</span>: <span class="variable language_">self</span>.calculate_md5(file_path),</span><br><span class="line">            <span class="string">&quot;mtime&quot;</span>: stat.st_mtime</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_md5</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算文件 MD5&quot;&quot;&quot;</span></span><br><span class="line">        hash_md5 = hashlib.md5()</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f.read(<span class="number">4096</span>), <span class="string">b&quot;&quot;</span>):</span><br><span class="line">                hash_md5.update(chunk)</span><br><span class="line">        <span class="keyword">return</span> hash_md5.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Unity AssetBundle 构建工具&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--platform&#x27;</span>, required=<span class="literal">True</span>, </span><br><span class="line">                       choices=[<span class="string">&#x27;StandaloneWindows64&#x27;</span>, <span class="string">&#x27;Android&#x27;</span>, <span class="string">&#x27;iOS&#x27;</span>, <span class="string">&#x27;WebGL&#x27;</span>],</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;目标平台&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--type&#x27;</span>, default=<span class="string">&#x27;Full&#x27;</span>,</span><br><span class="line">                       choices=[<span class="string">&#x27;Full&#x27;</span>, <span class="string">&#x27;Incremental&#x27;</span>, <span class="string">&#x27;Clean&#x27;</span>],</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;构建类型&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--version&#x27;</span>, default=<span class="string">&#x27;1.0.0&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;版本号&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 配置文件</span></span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="string">&#x27;unity_path&#x27;</span>: <span class="string">&#x27;C:\\Program Files\\Unity\\Hub\\Editor\\2021.3.21f1\\Editor\\Unity.exe&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;project_path&#x27;</span>: os.getcwd(),</span><br><span class="line">        <span class="string">&#x27;output_path&#x27;</span>: <span class="string">f&#x27;D:\\AB_Output\\build_<span class="subst">&#123;datetime.now().strftime(<span class="string">&quot;%Y%m%d_%H%M%S&quot;</span>)&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;platform&#x27;</span>: args.platform,</span><br><span class="line">        <span class="string">&#x27;build_type&#x27;</span>: args.<span class="built_in">type</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: args.version,</span><br><span class="line">        <span class="string">&#x27;build_number&#x27;</span>: os.environ.get(<span class="string">&#x27;BUILD_NUMBER&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建构建器并执行</span></span><br><span class="line">    builder = UnityABBuilder(config)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始构建 AssetBundle...&quot;</span>)</span><br><span class="line">        builder.build()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;生成资源清单...&quot;</span>)</span><br><span class="line">        manifest = builder.generate_manifest()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;构建完成！总计 <span class="subst">&#123;<span class="built_in">len</span>(manifest[<span class="string">&#x27;files&#x27;</span>])&#125;</span> 个文件，大小: <span class="subst">&#123;manifest[<span class="string">&#x27;total_size&#x27;</span>] / <span class="number">1024</span> / <span class="number">1024</span>:<span class="number">.2</span>f&#125;</span> MB&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exit(main())</span><br></pre></td></tr></table></figure>

<h3 id="2-文件校验脚本"><a href="#2-文件校验脚本" class="headerlink" title="2. 文件校验脚本"></a>2. 文件校验脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BuildScripts/check_ab_integrity.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_assetbundles</span>(<span class="params">manifest_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证 AB 包完整性&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(manifest_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        manifest = json.load(f)</span><br><span class="line">    </span><br><span class="line">    base_dir = os.path.dirname(manifest_path)</span><br><span class="line">    errors = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> file_info <span class="keyword">in</span> manifest[<span class="string">&#x27;files&#x27;</span>]:</span><br><span class="line">        file_path = os.path.join(base_dir, file_info[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            errors.append(<span class="string">f&quot;文件不存在: <span class="subst">&#123;file_info[<span class="string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查文件大小</span></span><br><span class="line">        actual_size = os.path.getsize(file_path)</span><br><span class="line">        <span class="keyword">if</span> actual_size != file_info[<span class="string">&#x27;size&#x27;</span>]:</span><br><span class="line">            errors.append(<span class="string">f&quot;文件大小不匹配: <span class="subst">&#123;file_info[<span class="string">&#x27;name&#x27;</span>]&#125;</span> &quot;</span></span><br><span class="line">                         <span class="string">f&quot;(预期: <span class="subst">&#123;file_info[<span class="string">&#x27;size&#x27;</span>]&#125;</span>, 实际: <span class="subst">&#123;actual_size&#125;</span>)&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查 MD5</span></span><br><span class="line">        actual_md5 = calculate_md5(file_path)</span><br><span class="line">        <span class="keyword">if</span> actual_md5 != file_info[<span class="string">&#x27;md5&#x27;</span>]:</span><br><span class="line">            errors.append(<span class="string">f&quot;MD5 不匹配: <span class="subst">&#123;file_info[<span class="string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> errors</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_md5</span>(<span class="params">file_path</span>):</span><br><span class="line">    hash_md5 = hashlib.md5()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f.read(<span class="number">4096</span>), <span class="string">b&quot;&quot;</span>):</span><br><span class="line">            hash_md5.update(chunk)</span><br><span class="line">    <span class="keyword">return</span> hash_md5.hexdigest()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、Jenkins-高级配置"><a href="#五、Jenkins-高级配置" class="headerlink" title="五、Jenkins 高级配置"></a>五、Jenkins 高级配置</h2><h3 id="1-Agent-节点配置"><a href="#1-Agent-节点配置" class="headerlink" title="1. Agent 节点配置"></a>1. Agent 节点配置</h3><p><strong>Windows Agent 配置步骤：</strong></p>
<ol>
<li>安装 Java JDK</li>
<li>下载 Jenkins agent.jar</li>
<li>创建服务启动脚本</li>
<li>在 Jenkins Master 添加节点</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Windows Agent 服务配置示例 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">service</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>jenkins-agent<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Jenkins Agent<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Jenkins Build Agent for Unity<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executable</span>&gt;</span>java<span class="tag">&lt;/<span class="name">executable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>-jar agent.jar -jnlpUrl http://jenkins-server:8080/computer/Unity-Windows/slave-agent.jnlp -secret YOUR_SECRET -workDir &quot;D:\Jenkins\workspace&quot;<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logmode</span>&gt;</span>rotate<span class="tag">&lt;/<span class="name">logmode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">onfailure</span> <span class="attr">action</span>=<span class="string">&quot;restart&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-构建触发器配置"><a href="#2-构建触发器配置" class="headerlink" title="2. 构建触发器配置"></a>2. 构建触发器配置</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多种触发方式</span></span><br><span class="line">triggers &#123;</span><br><span class="line">    <span class="comment">// 1. 定时构建</span></span><br><span class="line">    cron(<span class="string">&#x27;H 2 * * *&#x27;</span>)  <span class="comment">// 每天凌晨2点</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Git 推送触发</span></span><br><span class="line">    pollSCM(<span class="string">&#x27;H/5 * * * *&#x27;</span>)  <span class="comment">// 每5分钟检查一次</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 其他Job完成后触发</span></span><br><span class="line">    upstream(<span class="attr">upstreamProjects:</span> <span class="string">&#x27;unity-code-build&#x27;</span>, <span class="attr">threshold:</span> hudson.model.Result.SUCCESS)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 参数化构建触发</span></span><br><span class="line">    parameters &#123;</span><br><span class="line">        string(<span class="attr">name:</span> <span class="string">&#x27;BRANCH&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;master&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-并发构建控制"><a href="#3-并发构建控制" class="headerlink" title="3. 并发构建控制"></a>3. 并发构建控制</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">    <span class="comment">// 禁止并发构建</span></span><br><span class="line">    disableConcurrentBuilds()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 或限制并发数</span></span><br><span class="line">    throttleConcurrentBuilds(</span><br><span class="line">        <span class="symbol">throttleOption:</span> <span class="string">&#x27;project&#x27;</span>,</span><br><span class="line">        <span class="symbol">maxTotal:</span> <span class="number">2</span>,</span><br><span class="line">        <span class="symbol">maxPerNode:</span> <span class="number">1</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置超时时间</span></span><br><span class="line">    timeout(<span class="attr">time:</span> <span class="number">60</span>, <span class="attr">unit:</span> <span class="string">&#x27;MINUTES&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保留构建记录策略</span></span><br><span class="line">    buildDiscarder(logRotator(</span><br><span class="line">        <span class="symbol">numToKeepStr:</span> <span class="string">&#x27;20&#x27;</span>,</span><br><span class="line">        <span class="symbol">artifactNumToKeepStr:</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">    ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、优化与最佳实践"><a href="#六、优化与最佳实践" class="headerlink" title="六、优化与最佳实践"></a>六、优化与最佳实践</h2><h3 id="1-性能优化策略"><a href="#1-性能优化策略" class="headerlink" title="1. 性能优化策略"></a>1. 性能优化策略</h3><p><strong>构建速度优化：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 增量构建</span><br><span class="line">   - 只构建有变化的资源</span><br><span class="line">   - 缓存中间结果</span><br><span class="line"></span><br><span class="line">2. 并行构建</span><br><span class="line">   - 不同平台同时构建</span><br><span class="line">   - 分包并行构建</span><br><span class="line"></span><br><span class="line">3. 缓存策略</span><br><span class="line">   - 保留依赖库</span><br><span class="line">   - 预编译脚本</span><br></pre></td></tr></table></figure>

<p><strong>存储优化：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 分层存储</span><br><span class="line">   - 热资源放 SSD</span><br><span class="line">   - 冷资源放 HDD</span><br><span class="line"></span><br><span class="line">2. 压缩策略</span><br><span class="line">   - 使用 LZ4/LZMA 压缩</span><br><span class="line">   - 分块压缩大文件</span><br><span class="line"></span><br><span class="line">3. 去重策略</span><br><span class="line">   - 相同资源只打包一次</span><br><span class="line">   - 使用符号链接</span><br></pre></td></tr></table></figure>

<h3 id="2-错误处理机制"><a href="#2-错误处理机制" class="headerlink" title="2. 错误处理机制"></a>2. 错误处理机制</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkins Pipeline 错误处理</span></span><br><span class="line">stage(<span class="string">&#x27;错误处理与重试&#x27;</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        retry(<span class="number">3</span>) &#123;</span><br><span class="line">            script &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 构建操作</span></span><br><span class="line">                    buildAssetBundles()</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// 记录错误</span></span><br><span class="line">                    currentBuild.result = <span class="string">&#x27;FAILURE&#x27;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 发送告警</span></span><br><span class="line">                    sendAlert(e.message)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 清理临时文件</span></span><br><span class="line">                    cleanTempFiles()</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">throw</span> e</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果重试后仍失败，执行降级方案</span></span><br><span class="line">        script &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentBuild.result == <span class="string">&#x27;FAILURE&#x27;</span>) &#123;</span><br><span class="line">                echo <span class="string">&quot;构建失败，使用上一次成功的构建...&quot;</span></span><br><span class="line">                useLastSuccessfulBuild()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-安全最佳实践"><a href="#3-安全最佳实践" class="headerlink" title="3. 安全最佳实践"></a>3. 安全最佳实践</h3><p><strong>安全配置清单：</strong></p>
<ol>
<li><p><strong>凭据管理</strong></p>
<ul>
<li>使用 Jenkins Credentials 存储密码</li>
<li>限制凭据访问权限</li>
<li>定期轮换凭据</li>
</ul>
</li>
<li><p><strong>访问控制</strong></p>
<ul>
<li>设置构建节点白名单</li>
<li>限制脚本执行权限</li>
<li>审核构建日志</li>
</ul>
</li>
<li><p><strong>代码安全</strong></p>
<ul>
<li>扫描构建脚本中的敏感信息</li>
<li>验证第三方依赖</li>
<li>签名验证构建产物</li>
</ul>
</li>
</ol>
<hr>
<h2 id="七、监控与告警"><a href="#七、监控与告警" class="headerlink" title="七、监控与告警"></a>七、监控与告警</h2><h3 id="1-Jenkins-构建监控"><a href="#1-Jenkins-构建监控" class="headerlink" title="1. Jenkins 构建监控"></a>1. Jenkins 构建监控</h3><p><strong>关键监控指标：</strong></p>
<ul>
<li>构建成功率</li>
<li>构建持续时间</li>
<li>资源使用率</li>
<li>队列等待时间</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建指标收集</span></span><br><span class="line">post &#123;</span><br><span class="line">    always &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            <span class="comment">// 收集构建指标</span></span><br><span class="line">            <span class="keyword">def</span> metrics = [</span><br><span class="line">                <span class="string">&#x27;build_duration&#x27;</span>: currentBuild.duration,</span><br><span class="line">                <span class="string">&#x27;build_result&#x27;</span>: currentBuild.result,</span><br><span class="line">                <span class="string">&#x27;queue_time&#x27;</span>: currentBuild.queueTime,</span><br><span class="line">                <span class="string">&#x27;artifacts_size&#x27;</span>: getArtifactsSize(),</span><br><span class="line">                <span class="string">&#x27;ab_count&#x27;</span>: countAssetBundles()</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送到监控系统</span></span><br><span class="line">            sendToPrometheus(metrics)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入数据库</span></span><br><span class="line">            writeBuildMetrics(metrics)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-告警规则配置"><a href="#2-告警规则配置" class="headerlink" title="2. 告警规则配置"></a>2. 告警规则配置</h3><p><strong>告警触发条件：</strong></p>
<ol>
<li>连续 3 次构建失败</li>
<li>构建时间超过 30 分钟</li>
<li>AB 包数量异常减少</li>
<li>文件大小异常增长</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 智能告警</span></span><br><span class="line"><span class="keyword">def</span> checkBuildHealth() &#123;</span><br><span class="line">    <span class="keyword">def</span> recentBuilds = Jenkins.instance.getItemByFullName(env.JOB_NAME)</span><br><span class="line">        .getBuilds()</span><br><span class="line">        .limit(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> failureCount = recentBuilds.count &#123; it.result == <span class="string">&#x27;FAILURE&#x27;</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (failureCount &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">        sendAlert(<span class="string">&quot;连续 $&#123;failureCount&#125; 次构建失败！&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、扩展功能"><a href="#八、扩展功能" class="headerlink" title="八、扩展功能"></a>八、扩展功能</h2><h3 id="1-多环境部署"><a href="#1-多环境部署" class="headerlink" title="1. 多环境部署"></a>1. 多环境部署</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多环境配置</span></span><br><span class="line"><span class="keyword">def</span> environments = [</span><br><span class="line">    <span class="string">&#x27;dev&#x27;</span>: [</span><br><span class="line">        <span class="symbol">cdn_url:</span> <span class="string">&#x27;https://dev-cdn.yourgame.com&#x27;</span>,</span><br><span class="line">        <span class="symbol">bucket:</span> <span class="string">&#x27;game-ab-dev&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;test&#x27;</span>: [</span><br><span class="line">        <span class="symbol">cdn_url:</span> <span class="string">&#x27;https://test-cdn.yourgame.com&#x27;</span>,</span><br><span class="line">        <span class="symbol">bucket:</span> <span class="string">&#x27;game-ab-test&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prod&#x27;</span>: [</span><br><span class="line">        <span class="symbol">cdn_url:</span> <span class="string">&#x27;https://cdn.yourgame.com&#x27;</span>,</span><br><span class="line">        <span class="symbol">bucket:</span> <span class="string">&#x27;game-ab-prod&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;选择部署环境&#x27;</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            envConfig = environments[params.DEPLOY_ENV]</span><br><span class="line">            echo <span class="string">&quot;部署到 $&#123;params.DEPLOY_ENV&#125; 环境&quot;</span></span><br><span class="line">            echo <span class="string">&quot;CDN地址: $&#123;envConfig.cdn_url&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-自动化测试集成"><a href="#2-自动化测试集成" class="headerlink" title="2. 自动化测试集成"></a>2. 自动化测试集成</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;AB包功能测试&#x27;</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            <span class="comment">// 1. 完整性测试</span></span><br><span class="line">            runIntegrityTest()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 加载测试</span></span><br><span class="line">            runLoadTest()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 兼容性测试</span></span><br><span class="line">            runCompatibilityTest()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 性能测试</span></span><br><span class="line">            runPerformanceTest()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 测试报告</span></span><br><span class="line">        publishHTML([</span><br><span class="line">            <span class="symbol">allowMissing:</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="symbol">alwaysLinkToLastBuild:</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="symbol">keepAll:</span> <span class="literal">true</span>,</span><br><span class="line">            <span class="symbol">reportDir:</span> <span class="string">&#x27;test-results&#x27;</span>,</span><br><span class="line">            <span class="symbol">reportFiles:</span> <span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">            <span class="symbol">reportName:</span> <span class="string">&#x27;AB包测试报告&#x27;</span></span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-版本管理与回滚"><a href="#3-版本管理与回滚" class="headerlink" title="3. 版本管理与回滚"></a>3. 版本管理与回滚</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;版本管理&#x27;</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            <span class="comment">// 记录版本信息</span></span><br><span class="line">            <span class="keyword">def</span> versionInfo = [</span><br><span class="line">                <span class="symbol">build_number:</span> env.BUILD_NUMBER,</span><br><span class="line">                <span class="symbol">version:</span> params.AB_VERSION,</span><br><span class="line">                <span class="symbol">commit_hash:</span> env.GIT_COMMIT,</span><br><span class="line">                <span class="symbol">build_time:</span> <span class="keyword">new</span> Date().format(<span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>),</span><br><span class="line">                <span class="symbol">platform:</span> params.BUILD_PLATFORM,</span><br><span class="line">                <span class="symbol">artifacts:</span> [</span><br><span class="line">                    <span class="string">&#x27;ab_package&#x27;</span>: <span class="string">&quot;$&#123;env.OUTPUT_PATH&#125;/ab_package_$&#123;env.BUILD_NUMBER&#125;.zip&quot;</span>,</span><br><span class="line">                    <span class="string">&#x27;manifest&#x27;</span>: <span class="string">&quot;$&#123;env.OUTPUT_PATH&#125;/resource_manifest.json&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 保存到版本数据库</span></span><br><span class="line">            saveVersionInfo(versionInfo)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 打标签</span></span><br><span class="line">            <span class="keyword">if</span> (params.DEPLOY_ENV == <span class="string">&#x27;prod&#x27;</span>) &#123;</span><br><span class="line">                sh <span class="string">&quot;git tag v$&#123;params.AB_VERSION&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;git push origin v$&#123;params.AB_VERSION&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;回滚机制&#x27;</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            input <span class="attr">message:</span> <span class="string">&#x27;是否需要回滚?&#x27;</span>, <span class="attr">ok:</span> <span class="string">&#x27;确认回滚&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">def</span> rollbackVersion = input(</span><br><span class="line">                <span class="symbol">message:</span> <span class="string">&#x27;选择回滚到的版本&#x27;</span>,</span><br><span class="line">                <span class="symbol">parameters:</span> [</span><br><span class="line">                    choice(<span class="attr">name:</span> <span class="string">&#x27;VERSION&#x27;</span>, <span class="attr">choices:</span> getAvailableVersions())</span><br><span class="line">                ]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行回滚</span></span><br><span class="line">            rollbackToVersion(rollbackVersion)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="九、故障排查指南"><a href="#九、故障排查指南" class="headerlink" title="九、故障排查指南"></a>九、故障排查指南</h2><h3 id="常见问题及解决方案"><a href="#常见问题及解决方案" class="headerlink" title="常见问题及解决方案"></a>常见问题及解决方案</h3><table>
<thead>
<tr>
<th>问题现象</th>
<th>可能原因</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Unity 命令行构建失败</strong></td>
<td>Unity 版本不匹配</td>
<td>检查 Unity 安装路径和版本</td>
</tr>
<tr>
<td><strong>AB 包生成不全</strong></td>
<td>资源引用问题</td>
<td>检查 AssetBundle 命名设置</td>
</tr>
<tr>
<td><strong>构建超时</strong></td>
<td>资源过多或配置问题</td>
<td>增加超时时间，优化资源</td>
</tr>
<tr>
<td><strong>内存不足</strong></td>
<td>大资源打包</td>
<td>增加 JVM 内存，分批次构建</td>
</tr>
<tr>
<td><strong>网络上传失败</strong></td>
<td>网络问题或权限不足</td>
<td>检查网络连接和权限配置</td>
</tr>
<tr>
<td><strong>版本冲突</strong></td>
<td>多版本并存问题</td>
<td>清理旧版本，使用唯一版本号</td>
</tr>
</tbody></table>
<h3 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 启用详细日志</span></span><br><span class="line">bat <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &quot;$&#123;UNITY_PATH&#125;&quot; -batchmode -logFile &quot;$&#123;OUTPUT_PATH&#125;/detailed.log&quot; -projectPath &quot;$&#123;PROJECT_PATH&#125;&quot; ...</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 分步调试</span></span><br><span class="line">stage(<span class="string">&#x27;调试模式&#x27;</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            <span class="comment">// 逐步执行，检查每步结果</span></span><br><span class="line">            echo <span class="string">&quot;当前目录: $&#123;pwd()&#125;&quot;</span></span><br><span class="line">            echo <span class="string">&quot;Unity路径: $&#123;UNITY_PATH&#125;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 手动执行命令测试</span></span><br><span class="line">            <span class="keyword">if</span> (params.DEBUG_MODE) &#123;</span><br><span class="line">                input <span class="attr">message:</span> <span class="string">&#x27;暂停检查，按继续执行&#x27;</span>, <span class="attr">ok:</span> <span class="string">&#x27;继续&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 资源检查</span></span><br><span class="line"><span class="keyword">def</span> checkResources() &#123;</span><br><span class="line">    echo <span class="string">&quot;检查资源文件...&quot;</span></span><br><span class="line">    sh <span class="string">&quot;find . -name \&quot;*.prefab\&quot; | wc -l&quot;</span></span><br><span class="line">    sh <span class="string">&quot;find . -name \&quot;*.png\&quot; | wc -l&quot;</span></span><br><span class="line">    sh <span class="string">&quot;du -sh Assets/Resources/&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十、完整工作流示例"><a href="#十、完整工作流示例" class="headerlink" title="十、完整工作流示例"></a>十、完整工作流示例</h2><h3 id="典型工作流时间线"><a href="#典型工作流时间线" class="headerlink" title="典型工作流时间线"></a>典型工作流时间线</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">时间线（总时长约 15-30 分钟）：</span><br><span class="line">[00:00] 触发构建 (Git Push/定时/手动)</span><br><span class="line">[00:01] 拉取最新代码</span><br><span class="line">[00:02] 准备构建环境</span><br><span class="line">[00:03] Unity 构建 AssetBundle</span><br><span class="line">[10:00] 生成版本文件和清单</span><br><span class="line">[10:01] 压缩打包</span><br><span class="line">[10:02] 上传到 CDN</span><br><span class="line">[10:03] 自动化测试验证</span><br><span class="line">[10:10] 发送构建通知</span><br><span class="line">[10:15] 清理临时文件</span><br></pre></td></tr></table></figure>

<h3 id="团队协作流程"><a href="#团队协作流程" class="headerlink" title="团队协作流程"></a>团队协作流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">开发人员 → 提交代码到 Git → 触发 Jenkins 构建 → 自动打包 AB 包 → </span><br><span class="line">          ↓                                          ↓</span><br><span class="line">    本地验证 ←─── 下载测试包 ←─── 上传到测试环境 ←─── 测试通过</span><br><span class="line">          ↓                                          ↓</span><br><span class="line">    修复问题                                        生产发布</span><br></pre></td></tr></table></figure>

<p>通过这个完整的 Jenkins + Unity AB 打包方案，你可以实现：</p>
<ol>
<li><strong>自动化构建</strong> - 无需人工干预</li>
<li><strong>版本管理</strong> - 清晰的版本追踪</li>
<li><strong>质量控制</strong> - 自动化测试验证</li>
<li><strong>高效分发</strong> - 快速部署到 CDN</li>
<li><strong>团队协作</strong> - 统一的构建流程</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mr-liu-cheng.github.io">LiuCheng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mr-liu-cheng.github.io/2026/01/29/Jenkins%20%E6%89%93%E5%8C%85%20Unity%20AB%20%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88/">https://mr-liu-cheng.github.io/2026/01/29/Jenkins%20%E6%89%93%E5%8C%85%20Unity%20AB%20%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mr-liu-cheng.github.io" target="_blank">LiuCheng's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Jenkins-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/">Jenkins,自动化,打包</a></div><div class="post-share"><div class="social-share" data-image="/img/favicon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wxpay.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/29/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Docker%20%E9%95%9C%E5%83%8F/" title="深入理解 Docker 镜像"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">深入理解 Docker 镜像</div></div><div class="info-2"><div class="info-item-1">深入理解 Docker 镜像：从概念到本质一、镜像到底是什么？1. 官方定义 vs 通俗理解官方定义：  Docker 镜像是一个只读的模板，包含创建 Docker 容器所需的完整文件系统和配置。  通俗比喻：    概念 类比 说明    Docker 镜像 游戏的安装光盘 包含完整的游戏文件，但不能直接运行   Docker 容器 安装后的游戏 可以运行的游戏程序   Dockerfile 游戏制作说明书 说明如何制作这张光盘   Docker Registry 游戏商店 存放各种游戏光盘的地方   更贴近生活的比喻： 12345678910111. 你买了一个【乐高玩具盒】 → 这就是【镜像】   - 盒子里有：积木块（文件） + 说明书（配置）   - 但不能直接玩，只是材料2. 你按照说明书拼装 → 这就是【运行容器】   - 拼出来的【乐高模型】就是【容器】   - 可以玩，可以展示3. 你拼了多个一样的模型 → 这就是【多个容器实例】   - 每个都是独立的   - 但都来自同一个玩具盒  2....</div></div></div></a><a class="pagination-related" href="/2026/01/29/Github%20%E6%89%93%E9%95%9C%E5%83%8F/" title="Github 打镜像"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Github 打镜像</div></div><div class="info-2"><div class="info-item-1">GitHub 容器镜像（GitHub Container Registry）详解一、GitHub 容器镜像服务总览1. GitHub 提供的容器服务123456789GitHub 容器生态系统:┌─────────────────────────────────────────────────────┐│                   GitHub Container Registry          │ ← 容器镜像仓库│                   (ghcr.io)                         │├─────────────────────────────────────────────────────┤│                 GitHub Actions                       │ ← CI/CD 流水线├─────────────────────────────────────────────────────┤│                GitHub Packages              ...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">LiuCheng</div><div class="author-info-description">不积跬步无以至千里</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Mr-liu-cheng"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://mr-liu-cheng.github.io/img/weixin.jpg" target="_blank" title="WeChat"><i class="fa-brands fa-weixin" style="color: #00ff00;"></i></a><a class="social-icon" href="mailto:liuchengyg@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://mr-liu-cheng.github.io/img/qq.jpg" target="_blank" title="QQ"><i class="fa-brands fa-qq" style="color: #ffffff;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Stay hungry, stay foolish.</div></div><div class="card-widget study-widget" id="study-list"><div class="item-headline"><i class="fas fa-tasks"></i><span>学习目标</span></div><div class="item-content"><div>
  <ul>
    <li>Shader</li>
    <li>华佗热更新</li>
    <li>微信游戏发布</li>
    <li>Steam游戏发布</li>
    <li>广告SDK接入</li>
  </ul>
</div>
</div></div><div class="card-widget calendar-widget" id="calendar-list"><div class="item-headline"><i class="fas fa-tasks"></i><span>今日事今日毕</span></div><div class="item-content"><head>
    <meta charset="UTF-8">
    <title>FullCalendar 农历和调休示例</title>
    <script src='https://cdn.jsdelivr.net/npm/rrule@2.6.4/dist/es5/rrule.min.js'></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@latest/main.min.css" rel="stylesheet" />
</head>

<body>
    <a href="/Calendar/">
        <!-- 日历容器 -->
        <div id="calendar_aside"></div>
        <!-- FullCalendar JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@latest/main.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
        <!-- 引入农历库 -->
        <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@latest/lunar.min.js"></script>
        <!-- 本地脚本加载路径需要添加根目录节点-->
        <script src="/js/myCalendar.js"></script>
        <script>
            Show("calendar_aside");
        </script>
    </a>
</body>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkins-%E6%89%93%E5%8C%85-Unity-AB-%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">Jenkins 打包 Unity AB 资源完整方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Jenkins-Unity-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">一、Jenkins + Unity 自动化构建架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 核心架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E6%B8%85%E5%8D%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. 环境准备清单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">硬件环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">软件环境</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Jenkins-Pipeline-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.</span> <span class="toc-text">二、Jenkins Pipeline 配置方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%881%EF%BC%9AJenkinsfile-Pipeline-%E6%8E%A8%E8%8D%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">方案1：Jenkinsfile Pipeline (推荐)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%882%EF%BC%9AFreestyle-Job-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">方案2：Freestyle Job 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Unity-%E4%BE%A7%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.</span> <span class="toc-text">三、Unity 侧构建脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Unity-C-%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. Unity C# 构建脚本示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Unity-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. Unity 命令行参数解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7%E8%84%9A%E6%9C%AC"><span class="toc-number">1.4.</span> <span class="toc-text">四、辅助工具脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Python-%E6%9E%84%E5%BB%BA%E6%8E%A7%E5%88%B6%E8%84%9A%E6%9C%AC"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. Python 构建控制脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E6%A0%A1%E9%AA%8C%E8%84%9A%E6%9C%AC"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. 文件校验脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Jenkins-%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.</span> <span class="toc-text">五、Jenkins 高级配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Agent-%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. Agent 节点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 构建触发器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B9%B6%E5%8F%91%E6%9E%84%E5%BB%BA%E6%8E%A7%E5%88%B6"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 并发构建控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BC%98%E5%8C%96%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.</span> <span class="toc-text">六、优化与最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. 性能优化策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 错误处理机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 安全最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6"><span class="toc-number">1.7.</span> <span class="toc-text">七、监控与告警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Jenkins-%E6%9E%84%E5%BB%BA%E7%9B%91%E6%8E%A7"><span class="toc-number">1.7.1.</span> <span class="toc-text">1. Jenkins 构建监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.2.</span> <span class="toc-text">2. 告警规则配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD"><span class="toc-number">1.8.</span> <span class="toc-text">八、扩展功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="toc-number">1.8.1.</span> <span class="toc-text">1. 多环境部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E9%9B%86%E6%88%90"><span class="toc-number">1.8.2.</span> <span class="toc-text">2. 自动化测试集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E4%B8%8E%E5%9B%9E%E6%BB%9A"><span class="toc-number">1.8.3.</span> <span class="toc-text">3. 版本管理与回滚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%8C%87%E5%8D%97"><span class="toc-number">1.9.</span> <span class="toc-text">九、故障排查指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.9.1.</span> <span class="toc-text">常见问题及解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="toc-number">1.9.2.</span> <span class="toc-text">调试技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%AE%8C%E6%95%B4%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.10.</span> <span class="toc-text">十、完整工作流示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B8%E5%9E%8B%E5%B7%A5%E4%BD%9C%E6%B5%81%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="toc-number">1.10.1.</span> <span class="toc-text">典型工作流时间线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%A2%E9%98%9F%E5%8D%8F%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.10.2.</span> <span class="toc-text">团队协作流程</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/29/Github%20%E6%89%93%E9%95%9C%E5%83%8F/" title="Github 打镜像">Github 打镜像</a><time datetime="2026-01-29T12:06:02.000Z" title="发表于 2026-01-29 12:06:02">2026-01-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/29/Jenkins%20%E6%89%93%E5%8C%85%20Unity%20AB%20%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88/" title="Jenkins 打包 Unity AB 资源完整方案">Jenkins 打包 Unity AB 资源完整方案</a><time datetime="2026-01-29T12:06:02.000Z" title="发表于 2026-01-29 12:06:02">2026-01-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/29/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Docker%20%E9%95%9C%E5%83%8F/" title="深入理解 Docker 镜像">深入理解 Docker 镜像</a><time datetime="2026-01-29T12:06:02.000Z" title="发表于 2026-01-29 12:06:02">2026-01-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/29/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" title="网络游戏分布式架构">网络游戏分布式架构</a><time datetime="2026-01-29T12:06:02.000Z" title="发表于 2026-01-29 12:06:02">2026-01-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/28/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" title="Redis分布式锁">Redis分布式锁</a><time datetime="2026-01-28T12:06:02.000Z" title="发表于 2026-01-28 12:06:02">2026-01-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2026 By LiuCheng</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="music-button" type="button" title="music"><i class="fas fa-music"> </i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = {"language":"zh-CN","distractionFreeMode":true}

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23lisuIzc4KST5xLzO',
      clientSecret: '55972644d3071dd4c51a2e71064e336d2f51aa66',
      repo: 'mr-liu-cheng.github.io',
      owner: 'Mr-liu-cheng',
      admin: ['Mr-liu-cheng'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '4af1483e092ba9382502c046889892ff'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><div id="music-player" style="display: none;"></div><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script>  fetch("/music/playlist.json")    .then(response => response.json())    .then(data => {      const ap = new APlayer({        container: document.getElementById("music-player"),        fixed: true,        autoplay: false,        audio: data,        lrcType: 3      });    })    .catch(error => console.error("Error loading playlist:", error));</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>