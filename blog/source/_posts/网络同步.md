---
title: 网络同步
date: 2026-02-02 10:28:46
updated: 2026-02-02 10:28:46
tags: [帧同步,状态同步]
categories: 网络编程
keywords:  [帧同步,状态同步]
description:
---
帧同步与状态同步是网络游戏中最常用的两种**网络同步方案**，它们的核心差异在于 **“状态”由谁计算、如何传输**。

---

## 🎯 **核心思想对比**

| 维度 | **帧同步 (Lockstep)** | **状态同步 (State Synchronization)** |
| :--- | :--- | :--- |
| **同步内容** | 玩家的**操作指令**（例如：按了W、释放技能Q） | 游戏对象的**关键状态**（例如：位置、血量、速度） |
| **计算位置** | **客户端计算**完全一致的游戏逻辑，结果理论上一致 | **服务器计算**权威状态，下发给客户端 |
| **网络流量** | 低（只传操作，数据量小） | 高（需频繁同步大量状态数据） |
| **安全性** | 较低（依赖客户端防作弊，可通过逻辑校验、关键逻辑服务器化提升） | 高（服务器为权威状态，客户端仅为表现层） |
| **断线重连** | 复杂（需要追帧，补发缺失的操作序列） | 简单（直接同步当前状态即可） |
| **回放实现** | 非常简单（记录操作流重新执行即可） | 较复杂（需记录状态快照流） |
| **适用场景** | 强一致性、操作频繁、单位量多的 **RTS、MOBA、格斗**（如：星际争霸、王者荣耀） | 状态复杂、实时性要求相对宽松、重视安全性的 **MMO、FPS、开放世界**（如：魔兽世界、原神） |
| **开发复杂度** | 逻辑层要求**严格确定性**（浮点数、随机数、遍历顺序等都需一致） | 需处理**状态同步的插值、预测和容错**，网络层更复杂 |
| **带宽敏感度** | 延迟敏感（操作必须按帧顺序到达，卡顿会拖慢所有人） | 带宽敏感（状态数据量大，需压缩、优化同步频率） |

---

## 🕹️ **帧同步详解**

### 工作原理
1. **操作同步**：每个客户端将当前帧（如第N帧）的操作发送给服务器。
2. **广播转发**：服务器收集所有玩家第N帧的操作后，按相同顺序广播给所有客户端。
3. **确定执行**：每个客户端在第N帧使用**相同的操作输入**和**相同的初始状态**执行游戏逻辑，得到**完全一致**的第N+1帧状态。

### 关键技术点
- **确定性**：所有客户端的逻辑运算必须绝对一致（相同硬件、编译器、库版本）。
- **锁帧等待**：如果某玩家操作延迟到达，所有客户端都会等待，直到该帧数据到齐。
- **逻辑与渲染分离**：逻辑帧率固定（如每秒20帧），渲染帧率可以自由提高。

### 优势
- **极低的带宽消耗**：只传操作指令，适合移动网络。
- **完美的战斗一致性**：杜绝了状态不同步导致的战斗结果争议。
- **回放与观战简单**：只需记录操作流，回放时重新演算即可。

### 劣势
- **防作弊弱**：理论上客户端可以篡改逻辑（可通过服务器关键校验缓解）。
- **断线重连体验差**：重连时需要补发所有缺失操作，可能耗时较长。
- **开发约束大**：必须保证逻辑的确定性，不能使用本地浮点数、不确定的随机数等。

---

## 🌐 **状态同步详解**

### 工作原理
1. **客户端发送操作**：玩家操作（如移动、攻击）发送到服务器。
2. **服务器计算**：服务器验证并计算出新的游戏状态。
3. **状态同步**：服务器将状态（或状态变化）广播给所有客户端。
4. **客户端表现**：客户端根据收到的状态更新本地表现，常配合**插值**和**预测**以平滑显示。

### 关键技术点
- **服务器权威**：服务器是唯一的状态仲裁者。
- **同步优化**：
  - **快照同步**：定时发送完整状态快照（如Quake III）。
  - **增量同步**：只发送发生变化的状态（如Delta Compression）。
  - **优先级与兴趣管理**：只同步玩家可见/关心的对象（如AOI）。
- **客户端预测与回滚**：为了抵消网络延迟，客户端会预测本地操作结果，收到服务器状态后不一致时进行校正（如守望先锋的“回溯补偿”）。

### 优势
- **安全性高**：核心逻辑在服务器，客户端难以作弊。
- **断线重连快**：直接发送当前状态即可恢复。
- **开发灵活**：不要求确定性，可使用常规的编程方式。

### 劣势
- **带宽要求高**：状态数据量大，对服务器和网络压力大。
- **状态不一致风险**：网络延迟或丢包可能导致客户端短暂的状态不一致（如“瞬移”）。
- **回放复杂**：需要记录完整的状态流，数据量大。

---

## 🛠️ **混合方案与趋势**

在实际项目中，常根据需求**混合使用**两种方案：

- **MOBA（如王者荣耀）**：采用**帧同步**保证战斗绝对一致，但将**技能命中判定、伤害计算**等关键逻辑放在服务器进行二次验证（称为“帧同步+服务器校验”）。
- **大型FPS（如守望先锋）**：采用**状态同步**，但对玩家的移动和射击使用**客户端预测+服务器回滚**，在保证权威的同时降低操作延迟感。
- **MMO（如魔兽世界）**：以状态同步为主，但对非关键行为（如角色移动）采用客户端预测，关键行为（如战斗、交易）由服务器严格验证。

---

## 📊 **如何选择？**

可以根据以下问题做决策：

1. **游戏类型**？
   - RTS、MOBA、格斗 → **优先帧同步**。
   - MMO、FPS、开放世界 → **优先状态同步**。
2. **最看重什么**？
   - 绝对一致性、低带宽 → 帧同步。
   - 安全性、开发便捷性、断线恢复 → 状态同步。
3. **团队技术储备**？
   - 有较强的数学、引擎底层确定性保障能力 → 帧同步。
   - 更熟悉传统的客户端-服务器架构 → 状态同步。

---

## 💎 **总结**
- **帧同步**是“**操作同步+确定性计算**”，追求过程的绝对一致。
- **状态同步**是“**状态广播+权威服务器**”，追求结果的最终一致。

---


**有的，很多现代游戏采用了混合方案，结合了帧同步和状态同步的优势。** 这种“二者都有”的混合设计越来越普遍，尤其是在对延迟、一致性和安全性都有高要求的竞技游戏中。

## 🎮 **典型混合方案游戏案例**

### **1. MOBA类：王者荣耀 / League of Legends Mobile**
- **核心战斗采用帧同步**：移动、技能释放、小兵AI等，保证所有玩家看到的战斗过程完全一致。
- **关键逻辑服务器校验**：
  - 技能命中判定、伤害计算由服务器二次验证
  - 经济系统、装备购买等数值变化由服务器权威管理
- **大厅/社交系统用状态同步**：好友列表、聊天、匹配系统等。
- **为什么这样设计**：帧同步保证MOBA最核心的“公平对战体验”，服务器校验防止外挂篡改伤害等关键数据。

### **2. 竞技FPS类：守望先锋 / VALORANT**
- **基础架构是状态同步**：服务器拥有所有状态的最终决定权。
- **但融入了帧同步思想**：
  - **确定性逻辑**：使用固定步长物理更新，保证服务器和客户端的逻辑计算一致。
  - **客户端预测+服务器回滚**：本质上是“带权威服务器的帧同步思维”——客户端预测自己的操作，服务器按固定时间步长（tick）计算，如果发现客户端的预测错误，则回滚并纠正。
  - **命中判定采用“服务器权威+客户端验证”**：服务器在收到射击指令时，会根据当时的“历史帧”状态重新计算是否命中（这就是帧同步的确定性思想）。
- **其他系统用传统状态同步**：玩家数据、技能冷却、游戏模式状态等。

### **3. 大逃杀类：PUBG / APEX英雄**
- **移动和射击采用混合模式**：
  - 移动：客户端预测 + 服务器校正（类似状态同步中的预测）
  - 射击：服务器端重演计算（类似帧同步的确定性验证）
- **车辆物理、世界状态用状态同步**
- **安全区、物品刷新用服务器权威状态同步**

### **4. 实时策略类：星际争霸2（后期改进）**
- 虽然是经典的帧同步游戏，但在星际2中：
  - **基础游戏逻辑采用帧同步**
  - **天梯积分、成就等用状态同步**（与暴雪服务器通信）
  - **录像分析系统**可以看作是帧同步的回放特性

## 🔧 **常见的混合模式设计**

### **模式1：主帧同步 + 辅状态同步**
```
游戏核心循环（战斗、移动） → 帧同步
经济系统、积分、任务进度 → 状态同步
```
**优点**：保证了核心玩法的绝对公平，又用状态同步保护了重要数据不被篡改。

### **模式2：主状态同步 + 辅帧同步特性**
```
所有状态服务器权威 → 状态同步
但使用固定时间步长、确定性物理 → 帧同步思想
关键操作服务器重演验证 → 帧同步的确定性校验
```
**优点**：既有服务器权威的安全性，又能通过确定性计算减少同步数据量。

### **模式3：分层同步策略**
- **高频率、低延迟需求**的操作（移动、射击）→ 客户端预测 + 服务器确定性验证
- **低频率、高安全需求**的数据（生命值、得分）→ 服务器直接同步
- **非实时**的内容（装备、技能树）→ 完全的服务器状态同步

## 🏆 **最成功的混合案例：英雄联盟手游**
这是一个教科书级的混合方案：

1. **战斗系统**：纯帧同步，60FPS逻辑帧，保证所有手机上的技能时机完全一致。
2. **命中判定**：帧同步计算，但服务器会记录所有操作流，赛后可用于反作弊分析。
3. **经济系统**：服务器状态同步，防止本地修改金币。
4. **匹配系统**：传统HTTP/状态同步。
5. **断线重连**：使用帧同步追帧 + 状态同步的“当前状态快照”加速恢复。

## 📊 **为什么需要混合？**

| 需求 | 帧同步擅长 | 状态同步擅长 | 混合方案如何结合 |
|------|-----------|------------|----------------|
| **操作响应** | 延迟敏感（需等待最慢玩家） | 可客户端预测 | 非关键操作客户端预测，关键操作帧同步等待 |
| **防作弊** | 弱（逻辑在客户端） | 强（服务器权威） | 帧同步执行，服务器关键逻辑校验 |
| **断线恢复** | 慢（需追所有帧） | 快（同步当前状态） | 状态同步恢复基础状态，再追少量关键帧 |
| **带宽消耗** | 极低 | 高 | 高频操作用帧同步，低频状态变化用状态同步 |
| **开发复杂度** | 高（需确定性） | 中（需同步策略） | 不同模块用不同方案，复杂度分离 |

## 🚀 **未来趋势：确定性网络（Deterministic Networking）**
现代游戏引擎（如Unity的Netcode for Entities、Unreal的Chaos系统）正在推广一种融合思想：
- **所有客户端和服务器运行相同的确定性仿真**
- **只同步玩家输入**（像帧同步）
- **但服务器有最终仲裁权**（像状态同步）
- **支持客户端预测和服务器回滚**

这本质上是**带权威服务器的帧同步**，结合了二者的优点，正在成为竞技游戏的新标准。

## 💎 **结论**
纯帧同步或纯状态同步的游戏已经越来越少。**大多数现代多人在线游戏都是混合方案**，只是比例不同：
- **偏向帧同步的混合**：MOBA、RTS、格斗游戏
- **偏向状态同步的混合**：FPS、MMO、大逃杀

开发者根据游戏类型、安全需求、平台限制（如移动端带宽），在二者之间找到最适合自己游戏的平衡点。

选择哪种方案，本质上是**在一致性、安全性、带宽、开发成本之间做权衡**。现代大型游戏往往会根据模块特性灵活选用，甚至自研混合架构，以达到最佳体验。
